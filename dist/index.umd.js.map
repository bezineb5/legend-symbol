{"version":3,"file":"index.umd.js","sources":["../src/Circle.js","../src/Fill.js","../src/Line.js","../src/Symbol.js","../src/util.js","../src/index.js"],"sourcesContent":["export default function Circle (props) {\n  const {expr, layer} = props;\n\n  const radius = Math.min(\n    expr(layer, \"paint\", \"circle-radius\"),\n    8\n  );\n  const strokeWidth = Math.min(\n    expr(layer, \"paint\", \"circle-stroke-width\"),\n    4\n  );\n  const fillColor = expr(layer, \"paint\", \"circle-color\");\n  const fillOpacity = expr(layer, \"paint\", \"circle-opacity\");\n  const strokeColor = expr(layer, \"paint\", \"circle-stroke-color\");\n  const strokeOpacity = expr(layer, \"paint\", \"circle-stroke-opacity\");\n  const blur = expr(layer, \"paint\", \"circle-blur\");\n\n  const innerRadius = radius-strokeWidth/2;\n\n  return {\n    element: \"svg\",\n    attributes: {\n      viewBox: \"0 0 20 20\",\n      xmlns: \"http://www.w3.org/2000/svg\",\n      style: {\n        filter: `blur(${blur*innerRadius}px)`\n      }\n    },\n    children: [\n      {\n        element: \"circle\",\n        attributes: {\n          key: \"l1\",\n          cx: 10,\n          cy: 10,\n          fill: fillColor,\n          opacity: fillOpacity,\n          r: innerRadius,\n        },\n      },\n      {\n        element: \"circle\",\n        attributes: {\n          key: \"l2\",\n          cx: 10,\n          cy: 10,\n          fill: \"transparent\",\n          opacity: strokeOpacity,\n          r: radius,\n          \"stroke-width\": strokeWidth,\n          stroke: strokeColor,\n        },\n      },\n    ]\n  }\n}\n\n","export default function Fill (props) {\n  const {image, expr, layer} = props;\n  const dataUrl = image(\n    expr(layer, \"paint\", \"fill-pattern\")\n  );\n\n  const style = {\n    width: \"100%\",\n    height: \"100%\",\n    backgroundImage: `url(${dataUrl})`,\n    backgroundColor: expr(layer, \"paint\", \"fill-color\"),\n    opacity: expr(layer, \"paint\", \"fill-opacity\"),\n    backgroundSize: \"66% 66%\",\n    backgroundPosition: \"center\",\n  };\n\n  return {\n    element: \"div\",\n    attributes: {\n      style,\n    }\n  };\n}\n","export default function Line (props) {\n  const {layer, image, expr} = props;\n  const linePatternDataUrl = image(\n    expr(layer, \"paint\", \"line-pattern\")\n  );\n\n  const style = {\n    stroke: linePatternDataUrl ? `url(#img1)` : expr(layer, \"paint\", \"line-color\"),\n    strokeWidth: Math.max(2, Math.min(\n      expr(layer, \"paint\", \"line-width\"),\n      8\n    )),\n    strokeOpacity: expr(layer, \"paint\", \"line-opacity\"),\n  };\n  const sw = style.strokeWidth;\n\n  return {\n    element: \"svg\",\n    attributes: {\n      viewBox: \"0 0 20 20\",\n      xmlns: \"http://www.w3.org/2000/svg\"\n    },\n    children: [\n      {\n        element: \"defs\",\n        attributes: {\n          key: \"defs\",\n        },\n        children: [\n          {\n            element: \"pattern\",\n            attributes: {\n              key: \"pattern\",\n              id: \"img1\",\n              x: 0,\n              y: 0,\n              width: style.strokeWidth,\n              height: style.strokeWidth,\n              patternUnits: \"userSpaceOnUse\",\n              patternTransform: `translate(${-(sw/2)} ${-(sw/2)}) rotate(45)`\n            },\n            children: [\n              {\n                element: \"image\",\n                attributes: {\n                  key: \"img\",\n                  xlinkHref: linePatternDataUrl,\n                  x: 0,\n                  y: 0,\n                  width: style.strokeWidth,\n                  height: style.strokeWidth,\n                }\n              }\n            ]\n          }\n        ]\n      },\n      {\n        element: \"path\",\n        attributes: {\n          key: \"path\",\n          style,\n          stroke: style.stroke,\n          d: \"M0 20 L 20 0\",\n        }\n      }\n    ]\n  };\n}\n","function renderIconSymbol ({expr, layer, image}) {\n  const imgKey = expr(layer, \"layout\", \"icon-image\");\n\n  if (!imgKey) {\n    return null;\n  }\n  const dataUrl = image(imgKey);\n  if (dataUrl) {\n    return {\n      element: \"div\",\n      attributes: {\n        style: {\n          backgroundImage: `url(${dataUrl})`,\n          backgroundSize: \"contain\",\n          backgroundPosition: \"center\",\n          backgroundRepeat: \"no-repeat\",\n          width: \"100%\",\n          height: \"100%\",\n        }\n      },\n    };\n  }\n  else {\n    return null;\n  }\n}\n\nfunction renderTextSymbol ({expr, layer}) {\n  const textColor = expr(\n    layer, \"paint\", \"text-color\"\n  );\n  const textOpacity = expr(\n    layer, \"paint\", \"text-opacity\"\n  );\n  const textHaloColor = expr(\n    layer, \"paint\", \"text-halo-color\"\n  );\n  const textHaloWidth = expr(\n    layer, \"paint\", \"text-halo-width\"\n  );\n\n  // A \"T\" shape to signify text\n  const d = \"M 4,4 L 16,4 L 16,7 L 11.5 7 L 11.5 16 L 8.5 16 L 8.5 7 L 4 7 Z\";\n\n  return {\n    element: \"svg\",\n    attributes: {\n      viewBox: \"0 0 20 20\",\n      xmlns: \"http://www.w3.org/2000/svg\"\n    },\n    children: [\n      {\n        element: \"path\",\n        attributes: {\n          key: \"l1\",\n          d: d,\n          stroke: textHaloColor,\n          \"stroke-width\": textHaloWidth*2,\n          fill: \"transparent\",\n          \"stroke-linejoin\": \"round\",\n        }\n      },\n      {\n        element: \"path\",\n        attributes: {\n          key: \"l2\",\n          d: d,\n          fill: \"white\",\n        }\n      },\n      {\n        element: \"path\",\n        attributes: {\n          key: \"l3\",\n          d: d,\n          fill: textColor,\n          opacity: textOpacity,\n        }\n      },\n    ]\n  };\n}\n\nexport default function Symbol (props) {\n  return renderIconSymbol(props) || renderTextSymbol(props);\n}\n","import {\n  expression,\n  latest,\n  function as styleFunction\n} from '@mapbox/mapbox-gl-style-spec';\n\n\nconst PROP_MAP = [\n  [\"background\"],\n  [\"circle\"],\n  [\"fill-extrusion\"],\n  [\"fill\"],\n  [\"heatmap\"],\n  [\"hillshade\"],\n  [\"line\"],\n  [\"raster\"],\n  [\"icon\", \"symbol\"],\n  [\"text\", \"symbol\"],\n];\n\nexport function exprHandler ({zoom}) {\n  function prefixFromProp (prop) {\n    const out = PROP_MAP.find(def => {\n      const type = def[0];\n      return prop.startsWith(type);\n    });\n    return out ? (out[1] || out[0]) : null;\n  }\n\n  return function (layer, type, prop) {\n    const prefix = prefixFromProp(prop);\n    const specItem = latest[`${type}_${prefix}`][prop];\n    const dflt = specItem.default;\n\n    if (!layer[type]) {\n      return  dflt;\n    }\n\n    const input = layer[type][prop];\n\n    const objType = typeof(input);\n    // Is it an expression...\n    if (objType === \"undefined\") {\n      return specItem.default;\n    }\n    else if (typeof(input) === \"object\") {\n      let expr;\n      if (Array.isArray(input)) {\n        expr = expression.createExpression(input).value;\n      }\n      else {\n        expr = styleFunction.createFunction(input, specItem);\n      }\n      if (!expr.evaluate) {\n        return null;\n      }\n\n      const result = expr.evaluate({zoom}, {});\n      if (result) {\n        // Because it can be a resolved image.\n        return (result.name || result);\n      }\n      else {\n        return null;\n      }\n    }\n    else {\n      return input;\n    }\n  }\n}\n\n\n\nexport function mapImageToDataURL (map, icon) {\n  if (!icon) {\n    return undefined;\n  }\n\n  const image = map.style.imageManager.images[icon];\n  if (!image) {\n    return undefined;\n  }\n\n  const canvasEl = document.createElement(\"canvas\");\n  canvasEl.width = image.data.width;\n  canvasEl.height = image.data.height;\n  const ctx = canvasEl.getContext(\"2d\");\n  ctx.putImageData(\n    new ImageData(\n      Uint8ClampedArray.from(image.data.data),\n      image.data.width, image.data.height\n    ),\n    0, 0\n  );\n\n  // Not toBlob() because toDataURL is faster and synchronous.\n  return canvasEl.toDataURL();\n}\n\n\nconst dataStore = new Map();\nexport const cache = {\n  add: (key, value) => {\n    if (dataStore.has(key)) {\n      throw new Error(`Cache already contains '${key}'`);\n    }\n    dataStore.set(key, {\n      value,\n      count: 1\n    });\n  },\n  fetch: (key) => {\n    const cacheObj = dataStore.get(key);\n    if(cacheObj) {\n      cacheObj.count++;\n      return cacheObj.value;\n    }\n  },\n  release: (key) => {\n    const cacheObj = dataStore.get(key);\n    if(!cacheObj) {\n      throw new Error(`No such key in cache '${key}'`);\n    }\n    cacheObj.count--;\n\n    if (cacheObj.count === 0) {\n      dataStore.delete(key);\n    }\n  },\n};\n\nexport function loadImage (url) {\n  let cancelled = false;\n  const promise = new Promise((resolve, reject) => {\n    const img = new Image();\n    img.crossOrigin = \"Anonymous\";\n    img.onload = () => {\n      if (!cancelled) resolve(img);\n    }\n    img.onerror = e => {\n      if (!cancelled) reject(e);\n    };\n    img.src = url;\n  });\n  promise.cancel = () => {\n    cancelled = true;\n  }\n  return promise;\n}\n\nexport function loadJson (url) {\n  return fetch(url).then(res => res.json());\n}\n\n","import Circle from \"./Circle\";\nimport Fill from \"./Fill\";\nimport Line from \"./Line\";\nimport Symbol from \"./Symbol\";\nimport {exprHandler} from './util';\n\n\nfunction extractPartOfImage (img, {x, y, width, height}) {\n  const dpi = 2;\n  const el = document.createElement('canvas');\n  el.width = width*dpi;\n  el.height = height*dpi;\n  const ctx = el.getContext('2d');\n  ctx.drawImage(img,\n    x*dpi, y*dpi, width*dpi, height*dpi,\n    0, 0, width*dpi, height*dpi\n  );\n  return el.toDataURL();\n}\n\nexport default function ({sprite, zoom, layer}) {\n  const TYPE_MAP = {\n    \"circle\": Circle,\n    \"symbol\": Symbol,\n    \"line\": Line,\n    \"fill\": Fill,\n  };\n\n  const handler = TYPE_MAP[layer.type];\n  const expr = exprHandler({zoom});\n  const image = (imgKey) => {\n    if (sprite && sprite.json) {\n      const dimensions = sprite.json[imgKey];\n      if (dimensions) {\n        return extractPartOfImage(sprite.image, dimensions);\n      }\n    }\n    return null;\n  };\n\n  if (handler) {\n    return handler({layer, expr, image});\n  }\n  else {\n    return null;\n  }\n}\n"],"names":["Circle","props","expr","layer","radius","Math","min","strokeWidth","fillColor","fillOpacity","strokeColor","strokeOpacity","innerRadius","element","attributes","viewBox","xmlns","style","filter","children","key","cx","cy","fill","opacity","r","stroke-width","stroke","Fill","width","height","backgroundImage","image","backgroundColor","backgroundSize","backgroundPosition","Line","linePatternDataUrl","max","sw","id","x","y","patternUnits","patternTransform","xlinkHref","d","Symbol","imgKey","dataUrl","backgroundRepeat","renderIconSymbol","textColor","textOpacity","stroke-linejoin","PROP_MAP","zoom","sprite","handler","circle","symbol","line","type","prop","prefix","out","find","def","startsWith","prefixFromProp","specItem","latest","input","Array","isArray","expression","createExpression","value","styleFunction","createFunction","evaluate","result","name","json","dimensions","img","el","document","createElement","getContext","drawImage","toDataURL"],"mappings":"0RAAwBA,EAAQC,OACvBC,EAAeD,EAAfC,KAAMC,EAASF,EAATE,MAEPC,EAASC,KAAKC,IAClBJ,EAAKC,EAAO,QAAS,iBACrB,GAEII,EAAcF,KAAKC,IACvBJ,EAAKC,EAAO,QAAS,uBACrB,GAEIK,EAAYN,EAAKC,EAAO,QAAS,gBACjCM,EAAcP,EAAKC,EAAO,QAAS,kBACnCO,EAAcR,EAAKC,EAAO,QAAS,uBACnCQ,EAAgBT,EAAKC,EAAO,QAAS,yBAGrCS,EAAcR,EAAOG,EAAY,EAEvC,MAAO,CACLM,QAAS,MACTC,WAAY,CACVC,QAAS,YACTC,MAAO,6BACPC,MAAO,CACLC,eAVOhB,EAAKC,EAAO,QAAS,eAUPS,UAGzBO,SAAU,CACR,CACEN,QAAS,SACTC,WAAY,CACVM,IAAK,KACLC,GAAI,GACJC,GAAI,GACJC,KAAMf,EACNgB,QAASf,EACTgB,EAAGb,IAGP,CACEC,QAAS,SACTC,WAAY,CACVM,IAAK,KACLC,GAAI,GACJC,GAAI,GACJC,KAAM,cACNC,QAASb,EACTc,EAAGrB,EACHsB,eAAgBnB,EAChBoB,OAAQjB,eClDMkB,EAAM3B,OACdC,EAAeD,EAAfC,KAAMC,EAASF,EAATE,MAepB,MAAO,CACLU,QAAS,MACTC,WAAY,CACVG,MAbU,CACZY,MAAO,OACPC,OAAQ,OACRC,wBAPcC,EADa/B,EAAtB+B,OAEL9B,EAAKC,EAAO,QAAS,qBAOrB8B,gBAAiB/B,EAAKC,EAAO,QAAS,cACtCqB,QAAStB,EAAKC,EAAO,QAAS,gBAC9B+B,eAAgB,UAChBC,mBAAoB,qBCbAC,EAAMnC,OACrBE,EAAsBF,EAAtBE,MAAcD,EAAQD,EAARC,KACfmC,GAAqBL,EADE/B,EAAf+B,OAEZ9B,EAAKC,EAAO,QAAS,iBAGjBc,EAAQ,CACZU,OAAQU,eAAoCnC,EAAKC,EAAO,QAAS,cACjEI,YAAaF,KAAKiC,IAAI,EAAGjC,KAAKC,IAC5BJ,EAAKC,EAAO,QAAS,cACrB,IAEFQ,cAAeT,EAAKC,EAAO,QAAS,iBAEhCoC,EAAKtB,EAAMV,YAEjB,MAAO,CACLM,QAAS,MACTC,WAAY,CACVC,QAAS,YACTC,MAAO,8BAETG,SAAU,CACR,CACEN,QAAS,OACTC,WAAY,CACVM,IAAK,QAEPD,SAAU,CACR,CACEN,QAAS,UACTC,WAAY,CACVM,IAAK,UACLoB,GAAI,OACJC,EAAG,EACHC,EAAG,EACHb,MAAOZ,EAAMV,YACbuB,OAAQb,EAAMV,YACdoC,aAAc,iBACdC,+BAAiCL,EAAG,OAAQA,EAAG,kBAEjDpB,SAAU,CACR,CACEN,QAAS,QACTC,WAAY,CACVM,IAAK,MACLyB,UAAWR,EACXI,EAAG,EACHC,EAAG,EACHb,MAAOZ,EAAMV,YACbuB,OAAQb,EAAMV,kBAO1B,CACEM,QAAS,OACTC,WAAY,CACVM,IAAK,OACLH,MAAAA,EACAU,OAAQV,EAAMU,OACdmB,EAAG,4BCoBWC,EAAQ9C,GAC9B,OApFF,gBAAyC+B,IAAAA,MACjCgB,GAAS9C,IADWA,QAAMC,MACL,SAAU,cAErC,IAAK6C,EACH,YAEF,IAAMC,EAAUjB,EAAMgB,GACtB,OAAIC,EACK,CACLpC,QAAS,MACTC,WAAY,CACVG,MAAO,CACLc,uBAAwBkB,MACxBf,eAAgB,UAChBC,mBAAoB,SACpBe,iBAAkB,YAClBrB,MAAO,OACPC,OAAQ,eAmETqB,CAAiBlD,KAxDlBmD,GADoBlD,KAyDyBD,GAzDzBC,MAAMC,IAAAA,MAEvB,QAAS,cAEZkD,EAAcnD,EAClBC,EAAO,QAAS,gBAYX,CACLU,QAAS,MACTC,WAAY,CACVC,QAAS,YACTC,MAAO,8BAETG,SAAU,CACR,CACEN,QAAS,OACTC,WAAY,CACVM,IAAK,KACL0B,EAbFA,EAAI,kEAcFnB,OAtBczB,EACpBC,EAAO,QAAS,mBAsBVuB,eAA8B,EApBhBxB,EACpBC,EAAO,QAAS,mBAoBVoB,KAAM,cACN+B,kBAAmB,UAGvB,CACEzC,QAAS,OACTC,WAAY,CACVM,IAAK,KACL0B,EAAGA,EACHvB,KAAM,UAGV,CACEV,QAAS,OACTC,WAAY,CACVM,IAAK,KACL0B,EAAGA,EACHvB,KAAM6B,EACN5B,QAAS6B,OAjDnB,MAA4BnD,EAAMC,EAC1BiD,EAGAC,EAWAP,ECnCR,IAAMS,EAAW,CACf,CAAC,cACD,CAAC,UACD,CAAC,kBACD,CAAC,QACD,CAAC,WACD,CAAC,aACD,CAAC,QACD,CAAC,UACD,CAAC,OAAQ,UACT,CAAC,OAAQ,kBCGX,gBDA8BC,ECAJC,IAAAA,OAActD,IAAAA,MAQhCuD,EAPW,CACfC,OAAU3D,EACV4D,OAAUb,EACVc,KAAQzB,EACRb,KAAQK,GAGezB,EAAM2D,MACzB5D,GDTsBsD,ICAIA,cDSfrD,EAAO2D,EAAMC,GAC5B,IAAMC,EATR,SAAyBD,GACvB,IAAME,EAAMV,EAASW,KAAK,SAAAC,GAExB,OAAOJ,EAAKK,WADCD,EAAI,MAGnB,OAAOF,EAAOA,EAAI,IAAMA,EAAI,GAAM,KAInBI,CAAeN,GACxBO,EAAWC,SAAUT,MAAQE,GAAUD,GAG7C,IAAK5D,EAAM2D,GACT,OAHWQ,UAMb,IAAME,EAAQrE,EAAM2D,GAAMC,GAI1B,QAAgB,IAFOS,EAGrB,OAAOF,aAEkB,iBAAXE,EAAqB,CACnC,IAAItE,EAOJ,KALEA,EADEuE,MAAMC,QAAQF,GACTG,aAAWC,iBAAiBJ,GAAOK,MAGnCC,WAAcC,eAAeP,EAAOF,IAEnCU,SACR,YAGF,IAAMC,EAAS/E,EAAK8E,SAAS,CAACxB,KAAAA,GAAO,IACrC,OAAIyB,EAEMA,EAAOC,MAAQD,OAOzB,OAAOT,IC3BX,OAAId,EACKA,EAAQ,CAACvD,MAAAA,EAAOD,KAAAA,EAAM8B,MAXjB,SAACgB,GACb,GAAIS,GAAUA,EAAO0B,KAAM,CACzB,IAAMC,EAAa3B,EAAO0B,KAAKnC,GAC/B,GAAIoC,EACF,OA3BqBC,EA2BK5B,EAAOzB,MA3BNS,KA2Ba2C,GA3Bb3C,EAAGC,IAAAA,EAAGb,IAAAA,MAAOC,IAAAA,QAExCwD,EAAKC,SAASC,cAAc,WAC/B3D,MAFS,EAEDA,EACXyD,EAAGxD,OAHS,EAGAA,EACAwD,EAAGG,WAAW,MACtBC,UAAUL,EALF,EAMV5C,EANU,EAMHC,EANG,EAMIb,EANJ,EAMeC,EACzB,EAAG,EAPO,EAOJD,EAPI,EAOOC,GAEZwD,EAAGK,YAVZ,IAA6BN,IAAM5C,EAAGC,EAAGb,EAAOC,EAExCwD,EA4BJ"}